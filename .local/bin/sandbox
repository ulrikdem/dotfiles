#!/bin/bash

args=(
    --setenv SANDBOX ''
    --unshare-all
    --proc /proc
    --dev /dev
    --dir /tmp
    --dir /var/tmp
    --symlink /run /var/run
    --bind /tmp/sandbox-share ~/sandbox-share
)
mkdir -pm 700 /tmp/sandbox-share

for path in /bin /sbin /lib* /usr /opt /etc ~/.config/{mimeapps.list,highlight/themes/vim.theme} ~/.local/share/nvim/plugged "$XDG_RUNTIME_DIR/dconf-service/keyfile/defaults"; do
    [[ -L $path ]] && args+=(--symlink "$(readlink -- "$path")" "$path") || args+=(--ro-bind-try "$path" "$path")
done
while read -rd '' path; do
    args+=(--ro-bind-try ~/"$path" ~/"$path")
done < <(git --git-dir ~/.dotfiles.git ls-files -z)

add-path() {
    args+=(--$1 "${OPTARG%%=*}" "$(realpath -ms -- "${OPTARG#*=}")")
}

bind_args=
while getopts nxbRWr:w:d: opt; do
    case $opt in
        n) args+=(--share-net);;
        x)
            for path in ${XAUTHORITY:+"$XAUTHORITY"} "/tmp/.X11-unix/X${DISPLAY#:}" ${WAYLAND_DISPLAY:+"$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY"} "$XDG_RUNTIME_DIR"/{pipewire-0,pulse/native} /sys/dev{,ices}; do
                args+=(--ro-bind-try "$path" "$path")
            done
            for path in /dev/{dri,nvidia*}; do
                args+=(--dev-bind-try "$path" "$path")
            done;;
        b)
            path=$(sed -E 's/^unix:path=([^,]*).*/\1/' <<<$DBUS_SESSION_BUS_ADDRESS)
            args+=(--bind "$path" "$path");;
        R) bind_args=ro-bind;;
        W) bind_args=bind;;
        r) add-path ro-bind;;
        w) add-path bind;;
        d) add-path dev-bind-try;;
        ?) echo 'sandbox [-nxbRW] [-r path[=path]]... [-w path[=path]]... [-d path[=path]]... [command [arg]...]' >&2; exit 1;;
    esac
done
shift $((OPTIND - 1))

if [[ -n $bind_args ]]; then
    for arg; do
        [[ -e $arg ]] && args+=(--$bind_args "$arg" "$(realpath -s -- "$arg")")
    done
fi

(($#)) || set zsh
exec bwrap "${args[@]}" "$@"
